name: Deploy Published Release

on:
  release:
    types: [published]

jobs:
  deploy-release:
    name: Deploy Release to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download release archive
        run: |
          ASSET_URL=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            | jq -r '.assets[] | select(.name | endswith(".tar.gz")) | .browser_download_url')
          ASSET_NAME=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            | jq -r '.assets[] | select(.name | endswith(".tar.gz")) | .name')
          echo "Downloading: $ASSET_URL"
          echo "archive_name=$ASSET_NAME" >> $GITHUB_ENV
          curl -L -o archive.tar.gz "$ASSET_URL"

      - name: Extract archive
        run: |
          mkdir -p _site
          tar -xzf archive.tar.gz -C .
          ls -la _site

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.3.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies (for Vercel CLI)
        run: pnpm install

      - name: Deploy to Vercel Production
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: npx vercel deploy --archive=tgz --cwd=_site --prod --token="$VERCEL_TOKEN"

      - name: Upload to Codeberg
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
          CODEBERG_REPO: ${{ secrets.CODEBERG_REPO }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_NAME: ${{ github.event.release.name }}
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          if [ -z "$CODEBERG_TOKEN" ] || [ -z "$CODEBERG_REPO" ]; then
            echo "⊘ Codeberg not configured, skipping upload"
            exit 0
          fi

          # Create release on Codeberg
          # Use environment variables to avoid shell quoting issues
          RELEASE_DATA=$(jq -n \
            --arg tag "$RELEASE_TAG" \
            --arg name "$RELEASE_NAME" \
            --arg body "$RELEASE_BODY" \
            '{tag_name: $tag, name: $name, body: $body}')

          echo "Creating Codeberg release for $RELEASE_TAG..."
          CODEBERG_RELEASE=$(curl -s -X POST \
            -H "Authorization: token $CODEBERG_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$RELEASE_DATA" \
            "https://codeberg.org/api/v1/repos/$CODEBERG_REPO/releases")

          # Check if release was created successfully
          RELEASE_ID=$(echo "$CODEBERG_RELEASE" | jq -r '.id')

          if [ "$RELEASE_ID" = "null" ] || [ -z "$RELEASE_ID" ]; then
            echo "✗ Failed to create Codeberg release"
            echo "Response: $CODEBERG_RELEASE"
            exit 1
          fi

          echo "✓ Created Codeberg release (ID: $RELEASE_ID)"

          # Upload asset with the same filename as GitHub release
          echo "Uploading archive to Codeberg..."
          UPLOAD_RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $CODEBERG_TOKEN" \
            -H "Content-Type: multipart/form-data" \
            -F "attachment=@archive.tar.gz" \
            "https://codeberg.org/api/v1/repos/$CODEBERG_REPO/releases/$RELEASE_ID/assets?name=${{ env.archive_name }}")

          # Check if upload was successful
          if echo "$UPLOAD_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
            echo "✓ Uploaded to Codeberg as ${{ env.archive_name }}"
          else
            echo "✗ Failed to upload asset to Codeberg"
            echo "Response: $UPLOAD_RESPONSE"
            exit 1
          fi
