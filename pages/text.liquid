---
layout: base.liquid

pagination:
  data: textData
  size: 1
  alias: entry
  addAllPagesToCollections: true

permalink: '{{ entry.scx_path }}/index.html'
eleventyComputed:
  title: '{{ entry.acronym }}{% unless entry.scx_range_sutta_individual %}: {{ entry.original_title }}{% endunless %}—{{ entry.author }}'
  json_ld: '{{ entry.scx_json_ld }}'
  og_tags: '{{ entry.scx_og_tags }}'
  scripts:
    - 'userPrefs.js'
    - 'listen.js'
---
<header>
  {% assign parts = entry.scx_breadcrumb | split: "/" %}
  {% assign second_last = parts | size | minus: 1 %}
  {% capture breadcrumbsList %}
    {% for part in parts %}
      {% assign path = path | append: '/' | append: part %}
      <li>
        {% if forloop.last %}
          <a href="/{{ part }}" data-pagefind-body data-pagefind-weight="10">{{ part }}</a>
        {% elsif forloop.index == second_last %}
          <a href="/{{ part }}">{{ part }}</a>
        {% else %}
          <a href="/pitaka{{ path }}">{{ part }}</a>
        {% endif %}
      </li>
    {% endfor %}
    <li>
      <span aria-current="page">{{ entry.author_uid }}</span>
    </li>
  {% endcapture %}
  {% include "headerNav.liquid", breadcrumbsList: breadcrumbsList %}
</header>

<aside>
  <fieldset>
    <ul>
      <li>
        <button popovertarget="info" aria-label="Show publication information">
          Info
        </button>
      </li>
      <li>
        <button
          aria-haspopup="menu"
          aria-expanded="false"
          aria-controls="views-menu"
          aria-label="Text display settings"
          id="views-button"
        >
          Views
        </button>
        <ul
          class="dropdown"
          role="menu"
          aria-labelledby="views-button"
          id="views-menu"
        >
          {% if entry.has_comment
            or entry._bilarasuttas_data.variant_text.size > 0
          %}
            <li role="menuitem">
              {% if entry.is_root %}
                <label for="commenter">Show variants</label>
              {% else %}
                <label for="commenter">Show comments</label>
              {% endif %}
              <input
                type="checkbox"
                id="commenter"
                checked
                aria-controls="commenter-inline"
              >
            </li>
            <li role="menuitem">
              <label for="commenter-inline">↳ Inline</label>
              <input
                type="checkbox"
                id="commenter-inline"
                aria-controls="commenter-side"
              >
            </li>
            <li role="menuitem">
              <label for="commenter-side">↳ Side by side</label>
              <input type="checkbox" id="commenter-side">
            </li>
          {% endif %}
          {% unless entry.is_root or entry.segmented == blank %}
            <li role="menuitem">
              <label for="rooter">Show root text</label>
              <input
                type="checkbox"
                id="rooter"
                aria-controls="rooter-first rooter-side"
              >
            </li>
            <li role="menuitem">
              <label for="rooter-first">↳ Root first</label>
              <input type="checkbox" id="rooter-first">
            </li>
            <li role="menuitem">
              <label for="rooter-side">↳ Side by side</label>
              <input type="checkbox" id="rooter-side">
            </li>
          {% endunless %}
          {% if entry.segmented
            or entry._suttas_data.translation.text contains "class='ref"
          %}
            <li role="menuitem">
              <label for="segmenter">Show segments</label>
              <input type="checkbox" id="segmenter">
            </li>
          {% endif %}
          <li role="menuitem">
            <label for="positioner">Pin this menu</label>
            <input type="checkbox" id="positioner" checked>
          </li>
        </ul>
      </li>
      <li>
        <button popovertarget="parallels" aria-label="Show parallel texts">
          Parallels
        </button>
      </li>
      <li>
        <button
          aria-haspopup="menu"
          aria-expanded="false"
          aria-controls="listen-menu"
          aria-label="Text to speech settings"
          id="listen-menu-button"
        >
          Listen
        </button>
        <ul
          class="dropdown"
          role="menu"
          aria-labelledby="listen-menu-button"
          id="listen-menu"
        >
          <li>
            <noscript>
              Please enable javascript to listen to this text. It works 100%
              locally in your browser via the SpeechSynthesis API, including
              while offline.
            </noscript>
          </li>
          <li role="menuitem" class="tts-controls">
            <button id="prev" type="button">
              <span>⏮️</span><span>Prev</span>
            </button>
            <button id="playpause" type="button">
              <span>▶️</span><span>Play</span>
            </button>
            <button id="stop" type="button">
              <span>⏹️</span><span>Stop</span>
            </button>
            <button id="next" type="button">
              <span>⏭️</span><span>Next</span>
            </button>
          </li>
          <li role="menuitem">
            <label for="voice-select">Voice</label>
            <select id="voice-select"></select>
          </li>
          <li role="menuitem">
            <label for="rate">Rate</label>
            <input
              type="range"
              min="0.5"
              max="2"
              value="1"
              step="0.1"
              id="rate"
            >
            <div id="rate-value">1.0</div>
          </li>
          <li role="menuitem">
            <label for="pitch">Pitch</label>
            <input
              type="range"
              min="0"
              max="2"
              value="1"
              step="0.1"
              id="pitch"
            >
            <div id="pitch-value">1.0</div>
          </li>
          <li role="menuitem">
            <label for="auto-scroll">Auto-scroll</label>
            <input type="checkbox" id="auto-scroll">
          </li>
        </ul>
      </li>
    </ul>
  </fieldset>
</aside>

<main
  data-pagefind-body
  data-acronym="{{ entry.acronym }}"
  data-author="{{ entry.author }}"
  data-lang="{{ entry.lang }}"
  data-title="{{ entry.translated_title | default: entry.translated_name }}"
  data-translatorstitle="{{ entry._suttas_data.translation.title | default: '' }}"
  data-originaltitle="{{ entry.original_title }}"
  data-pagefind-meta="acronym[data-acronym], author[data-author], lang[data-lang], title[data-title], translatorsTitle[data-translatorstitle], originalTitle[data-originaltitle]"
>
  {% if entry.is_root and entry._bilarasuttas_data.size > 0 %}
    {% assign comments = "" %}
    {% for key in entry._bilarasuttas_data.keys_order %}
      {% comment %}
        First, decide whether or not to "process" a key for range-suttas
        every other text should always process all keys and skips this intro
      {% endcomment %}
      {% assign should_process = true %}
      {% assign is_header = false %}

      {% if entry.scx_range_sutta_individual %}
        {% comment %}
          Check if this key is a :0.X header key, as this is where the headings are.
          These are useful for all texts in the range as including this heading gives context to the text
        {% endcomment %}
        {% assign key_segment = key | split: ":" | last %}
        {% if key_segment contains "0." %}
          {% assign header_html = entry._bilarasuttas_data.html_text[key] %}

          {% if header_html contains "<article id=" %}
            {% comment %}
              Article-specific header (e.g., "<article id='dhp1'>" or "<article id='an1.258-267'>")
              Extract the id and check if it matches this `entry.uid` or `entry.scx_range_sutta_uid`
            {% endcomment %}
            {% assign article_id_parts = header_html | split: "id='" %}
            {% assign article_id = article_id_parts[1] | split: "'" | first %}

            {% if article_id == entry.scx_range_sutta_uid
              or article_id == entry.uid
            %}
              {% assign is_header = true %}
            {% endif %}
          {% else %}
            {% comment %}
              Global range header (e.g., division, subdivision, range-title)
              These apply to all suttas in the range
            {% endcomment %}
            {% assign is_header = true %}
          {% endif %}
        {% endif %}

        {% comment %}
          Check if this is the last key
          (ie for the closing </article> and </section> tags)
        {% endcomment %}
        {% assign last_index = entry._bilarasuttas_data.keys_order.size
          | minus: 1
        %}
        {% assign is_last_key = false %}
        {% if forloop.index0 == last_index %}
          {% assign is_last_key = true %}
        {% endif %}

        {% comment %}
          Check if key matches the text uid or falls within a sub-range
          (ie sub-ranges on /an1.575-615)
        {% endcomment %}
        {% assign key_id = key | split: ":" | first %}
        {% assign matches_uid = false %}
        {% if key_id == entry.uid %}
          {% assign matches_uid = true %}
        {% elsif key_id contains "-" %}
          {% comment %} Check if entry.uid falls within this range {% endcomment %}
          {% assign range_parts = key_id | split: "-" %}
          {% assign range_start = range_parts[0] %}
          {% assign range_end_str = range_parts[1] %}

          {% comment %} Extract numeric parts for comparison {% endcomment %}
          {% assign uid_num_str = entry.uid | split: "." | last %}
          {% assign uid_num = uid_num_str | plus: 0 %}

          {% assign start_num_str = range_start | split: "." | last %}
          {% assign start_num = start_num_str | plus: 0 %}
          {% assign end_num = range_end_str | plus: 0 %}

          {% if uid_num >= start_num and uid_num <= end_num %}
            {% assign matches_uid = true %}
          {% endif %}
        {% endif %}

        {% comment %} Include if it's a header, last key, or matches uid {% endcomment %}
        {% if is_header or is_last_key or matches_uid %}
          {% assign should_process = true %}
        {% else %}
          {% assign should_process = false %}
        {% endif %}
      {% endif %}

      {% if should_process %}
        {% assign html = entry._bilarasuttas_data.html_text[key] %}
        {% comment %} Handle individual range suttas some more... {% endcomment %}
        {% if entry.scx_range_sutta_individual and is_last_key %}
          {% assign last_key_prefix = key | split: ":" | first %}
          {% unless last_key_prefix == entry.uid %}
            {% comment %} These .end* <p> tag's are only needed on the last sutta in vagga/book {% endcomment %}
            {% assign html = html | replace: "<p class='endvagga'>{}</p>", "" %}
            {% assign html = html | replace: "<p class='end'>{}</p>", "" %}
            {% assign html = html | replace: "<p class='endbook'>{}</p>", "" %}
            {% comment %}
              Stricter check to handle other cases...
              ie an11.22/en/sujato to an11.29/en/sujato (/pli/ms also)
            {% endcomment %}
            {% comment %} But first exclude ie range an11.30/en/sujato to an11.69 where the last value is "{}</p></article>" {% endcomment %}
            {% assign html_first_two_chars = html | slice: 0, 2 %}
            {% if html contains "</article>" and html_first_two_chars != "{}" %}
              {% unless html contains entry.uid %}
                {% comment %} Remove everything except the closing tag(s) {% endcomment %}
                {% assign html = html
                  | split: "</article>"
                  | last
                  | prepend: "</article>"
                %}
              {% endunless %}
            {% endif %}
          {% endunless %}
        {% endif %}
        {% assign text = entry._bilarasuttas_data.root_text[key] %}
        {% assign comment = entry._bilarasuttas_data.variant_text[key] %}
        {% assign ref = key | split: ":" | last %}

        {% if html %}
          {% capture replacement %}
          <span id="{{ key }}" class="segment">
            <span class="reference" id="{{ ref }}">
              <a href="#{{ ref }}" title="SuttaCentral segment number">{{ ref }}</a>
            </span>
            {% if text %}
            <!-- This is not a translation, its the root text, the class is so it's not `display: none` by default. -->
            <span class="translation" lang="{{ entry.lang }}" translate="no">
              {% if entry.scx_range_sutta_individual and is_header %}
                {% comment %} Handle untitled root texts, eg range an11.22/pli/ms to 11.29 (and 30-69) has ~ as the title {% endcomment %}
                {% if text contains '~' %}
                  {% if html contains "class='range-title'" or html contains "class='sutta-title'" %}
                    {% capture text %}{{ entry.scx_range_sutta_title }}{% endcapture %}
                  {% endif %}
                {% endif %}
              {% endif %}
              <span class="text">{{ text }}</span>
              {% unless comment == blank %}
                <button popovertarget="comment-{{ key }}" aria-label="Show variant reading for segment {{ ref }}">*</button>
                <span class="inline-comment" aria-label="Variant reading for segment {{ ref }}">
                  Variant: {{ comment | replace: 'https://suttacentral.net', '' }}
                </span>
              {% endunless %}
            </span>
            {% endif %}
          </span>
          {% endcapture %}
          {{ html | replace: "{}", replacement }}
          {%- if comment -%}
            {% capture comments %}
            {{ comments }}
            <article id="comment-{{ key }}" popover>
              Variant: {{ comment | replace: 'https://suttacentral.net', '' }}
            </article>
            {% endcapture %}
          {%- endif -%}
        {% endif %}
      {% endif %}
    {% endfor %}
    {{ comments }}
    <article id="info" popover>
      {% include "publicationInfo.liquid", entry: entry %}
    </article>
  {% elsif entry.segmented %}
    {% assign comments = "" %}
    {% for key in entry._bilarasuttas_data.keys_order %}
      {% comment %}
        First, decide whether or not to "process" a key for range-suttas
        every other text should always process all keys and skips this intro
      {% endcomment %}
      {% assign should_process = true %}
      {% assign is_header = false %}

      {% if entry.scx_range_sutta_individual %}
        {% comment %}
          Check if this key is a :0.X header key, as this is where the headings are.
          These are useful for all texts in the range as including this heading gives context to the text
        {% endcomment %}
        {% assign key_segment = key | split: ":" | last %}
        {% if key_segment contains "0." %}
          {% assign header_html = entry._bilarasuttas_data.html_text[key] %}

          {% if header_html contains "<article id=" %}
            {% comment %}
              Article-specific header (e.g., "<article id='dhp1'>" or "<article id='an1.258-267'>")
              Extract the id and check if it matches this `entry.uid` or `entry.scx_range_sutta_uid`
            {% endcomment %}
            {% assign article_id_parts = header_html | split: "id='" %}
            {% assign article_id = article_id_parts[1] | split: "'" | first %}

            {% if article_id == entry.scx_range_sutta_uid
              or article_id == entry.uid
            %}
              {% assign is_header = true %}
            {% endif %}
          {% else %}
            {% comment %}
              Global range header (e.g., division, subdivision, range-title)
              These apply to all suttas in the range
            {% endcomment %}
            {% assign is_header = true %}
          {% endif %}
        {% endif %}

        {% comment %}
          Check if this is the last key
          (ie for the closing </article> and </section> tags)
        {% endcomment %}
        {% assign last_index = entry._bilarasuttas_data.keys_order.size
          | minus: 1
        %}
        {% assign is_last_key = false %}
        {% if forloop.index0 == last_index %}
          {% assign is_last_key = true %}
        {% endif %}

        {% comment %}
          Check if key matches the text uid or falls within a sub-range
          (ie sub-ranges on /an1.575-615)
        {% endcomment %}
        {% assign key_id = key | split: ":" | first %}
        {% assign matches_uid = false %}
        {% if key_id == entry.uid %}
          {% assign matches_uid = true %}
        {% elsif key_id contains "-" %}
          {% comment %} Check if entry.uid falls within this range {% endcomment %}
          {% assign range_parts = key_id | split: "-" %}
          {% assign range_start = range_parts[0] %}
          {% assign range_end_str = range_parts[1] %}

          {% comment %} Extract numeric parts for comparison {% endcomment %}
          {% assign uid_num_str = entry.uid | split: "." | last %}
          {% assign uid_num = uid_num_str | plus: 0 %}

          {% assign start_num_str = range_start | split: "." | last %}
          {% assign start_num = start_num_str | plus: 0 %}
          {% assign end_num = range_end_str | plus: 0 %}

          {% if uid_num >= start_num and uid_num <= end_num %}
            {% assign matches_uid = true %}
          {% endif %}
        {% endif %}

        {% comment %} Include if it's a header, last key, or matches uid {% endcomment %}
        {% if is_header or is_last_key or matches_uid %}
          {% assign should_process = true %}
        {% else %}
          {% assign should_process = false %}
        {% endif %}
      {% endif %}

      {% if should_process %}
        {% assign html = entry._bilarasuttas_data.html_text[key] %}
        {% comment %} Handle individual range suttas some more... {% endcomment %}
        {% if entry.scx_range_sutta_individual and is_last_key %}
          {% assign last_key_prefix = key | split: ":" | first %}
          {% unless last_key_prefix == entry.uid %}
            {% comment %} These .end* <p> tag's are only needed on the last sutta in vagga/book {% endcomment %}
            {% assign html = html | replace: "<p class='endvagga'>{}</p>", "" %}
            {% assign html = html | replace: "<p class='end'>{}</p>", "" %}
            {% assign html = html | replace: "<p class='endbook'>{}</p>", "" %}
            {% comment %}
              Stricter check to handle other cases...
              ie an11.22/en/sujato to an11.29/en/sujato (/pli/ms also)
            {% endcomment %}
            {% comment %} But first exclude ie range an11.30/en/sujato to an11.69 where the last value is "{}</p></article>" {% endcomment %}
            {% assign html_first_two_chars = html | slice: 0, 2 %}
            {% if html contains "</article>" and html_first_two_chars != "{}" %}
              {% unless html contains entry.uid %}
                {% comment %} Remove everything except the closing tag(s) {% endcomment %}
                {% assign html = html
                  | split: "</article>"
                  | last
                  | prepend: "</article>"
                %}
              {% endunless %}
            {% endif %}
          {% endunless %}
        {% endif %}
        {% assign text = entry._bilarasuttas_data.translation_text[key] %}
        {% assign rootText = entry._bilarasuttas_data.root_text[key] %}
        {% assign comment = entry._bilarasuttas_data.comment_text[key] %}
        {% assign ref = key | split: ":" | last %}

        {% if html %}
          {% capture replacement %}
          <span id="{{ key }}" class="segment">
            <span class="reference" id="{{ ref }}">
              <a href="#{{ ref }}" title="SuttaCentral segment number">{{ ref }}</a>
            </span>
            {% if text %}
              <span class="translation" lang="{{ entry.lang }}"{% if text == entry.translated_title or text == entry.translated_name %} data-pagefind-weight="8"{% endif %}>
            {% if entry.scx_range_sutta_individual and is_header %}
              {% if text == entry.translated_title or text == entry.translated_name %}
                {% capture text %}{{ entry.scx_range_sutta_title }}{% endcapture %}
              {% endif %}
            {% endif %}
            <span class="text">{{ text }}</span>
              {% unless comment == blank %}
                <button popovertarget="comment-{{ key }}" aria-label="Show {{ entry.author }}'s footnote for segment {{ key }}">*</button>
                <span class="inline-comment" aria-label="{{ entry.author }}'s footnote for segment {{ key }}">
                  {{ comment | replace: 'https://suttacentral.net', '' }}
                </span>
              {% endunless %}
            </span>
            {% endif %}
            {% if rootText %}
              {% assign normalisedRoot = rootText | normalise %}
              {% assign normalisedTitle = entry.original_title | normalise %}
              <span class="root" lang="{{ entry.root_lang }}" translate="no" {% unless normalisedRoot contains normalisedTitle %}data-pagefind-ignore="all"{% endunless %}>
                {% if entry.scx_range_sutta_individual and is_header %}
                  {% if text == entry.scx_range_sutta_title %}
                    {% capture rootText %}{{ entry.scx_range_sutta_title }}{% endcapture %}
                  {% endif %}
                {% endif %}
                <span class="text">{{ rootText }}</span>
              </span>
            {% endif %}
          </span>
          {% endcapture %}
          {{ html | replace: "{}", replacement }}
          {%- if comment -%}
            {% capture comments %}
            {{ comments }}
            <article id="comment-{{ key }}" popover>
              {{ comment | replace: 'https://suttacentral.net', '' }}
            </article>
          {% endcapture %}
          {%- endif -%}
        {% endif %}
      {% endif %}
    {% endfor %}
    {{ comments }}
    {% if entry._publication_info != blank %}
      <article id="info" popover>
        {% include "publicationInfo.liquid", entry: entry %}
      </article>
    {% endif %}
  {% else %}
    {% assign html_content = entry._suttas_data.translation.text
      | replace: "\n", ""
    %}
    {% assign original_footer = html_content
      | split: "<footer"
      | last
      | split: "</footer>"
      | first
      | prepend: "<footer"
      | append: "</footer>"
    %}
    {% assign html_without_footer = html_content
      | replace: original_footer, ""
    %}
    {% assign modified_footer = original_footer
      | replace: "<footer", '<article id="info" popover'
      | replace: "</footer>", "</article>"
    %}
    {{ html_without_footer }}
    {{ modified_footer }}
  {% endif %}

  <article id="parallels" popover>
    {% assign left_title = entry.original_title | default: entry.root_name %}
    {% assign right_title = entry.translated_title
      | default: entry.translated_name
    %}
    {% if right_title != blank %}
      {% assign full_title = left_title | append: "—" | append: right_title %}
    {% else %}
      {% assign full_title = left_title %}
    {% endif %}
    {% include "textMetaContent.liquid",
      entry: entry,
      title: full_title,
      translations: entry._suttas_data.suttaplex.translations,
      parallelsOpen: true
    %}
  </article>
</main>

<nav aria-label="Article pagination">
  <div>
    {% unless entry._suttas_data.translation.previous.uid == blank
      and entry.scx_range_sutta_pagination.prev.uid == blank
    %}
      <span>Previous</span>
      <a
        href="/{{ entry.scx_range_sutta_pagination.prev.uid | default: entry._suttas_data.translation.previous.uid }}/{{ entry._suttas_data.translation.previous.lang }}/{{ entry._suttas_data.translation.previous.author_uid }}"
        rel="prev"
      >
        {{
          entry.scx_range_sutta_pagination.prev.name
          | default: entry._suttas_data.translation.previous.name
        }}
      </a>
    {% endunless %}
  </div>
  <div>
    {% unless entry._suttas_data.translation.next.uid == blank
      and entry.scx_range_sutta_pagination.next.uid == blank
    %}
      <span>Next</span>
      <a
        href="/{{ entry.scx_range_sutta_pagination.next.uid | default: entry._suttas_data.translation.next.uid }}/{{ entry._suttas_data.translation.next.lang }}/{{ entry._suttas_data.translation.next.author_uid }}"
        rel="prev"
      >
        {{
          entry.scx_range_sutta_pagination.next.name
          | default: entry._suttas_data.translation.next.name
        }}
      </a>
    {% endunless %}
  </div>
</nav>

{% include "footer.liquid",
  route: entry.scx_path,
  fetchedAt: entry.scx_fetched_at
%}

{% if _siteMetaData.environment == "dev" %}
  <script>
    const data = {{ entry | jsonify }};
    console.log(data);
  </script>
{% endif %}
